---
title: "Nuclear Data Mapping"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme : sandstone #readable #spacelab
    logo: ../../www/logo.jpg
    includes:
      after_body: ../../html/footer.html
    #css: mystyles.css
params:
  SYMAMLIBVER: "U-233-g-JEFF-3.3"
  LIBVER2: "JEFF-3.2"
  
---
<style>                     
.navbar {
  background-color:white;
  border-color:gray;
}
.navbar-brand {
color:DarkSlateGray!important;
}
.dataTables_wrapper{
font-family: helvetica;
font-size: 11px; 
}

</style>  

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)


source("../../global.R")

#define parameters to be used here : 
myparams<-strsplit(params$SYMAMLIBVER, "-")[[1]]
 
mX<-myparams[1]
mA<-myparams[2]
mM<-myparams[3]
mLIB<-myparams[4]
mVER<-myparams[5]
mSYMAM<-paste(mX,"-", mA,"-",mM, sep ="")
mLIBVER<-paste(mLIB,"-",mVER, sep = "")

#for use by wrapper.R : 
output_dir<-paste(mLIB,mVER, sep = "")
output_file<-paste(mX,mA,mM)

#for use by datatables :
pdf<-df%>%subset(X==mX & A==mA & M==mM & LIBVER==mLIBVER)
tot<-dim(pdf)[1]

# preparing datatables
pdfo<-df%>%subset(X==mX & A==mA & M==mM)
lib2<-pdfo%>%subset(LIBVER==params$LIBVER2, 
                    select = c('MFMT', 'MF', 'MFDES', 'MT', "MTDES", 'LIBVER', 'LIBVERORIG'))
lib1<-pdfo%>%subset(LIBVER==mLIBVER,
                    select = c('MFMT', 'MF', 'MFDES', 'MT', "MTDES", 'LIBVER', 'LIBVERORIG'))
comp<-merge(lib1, lib2, by = c('MFMT', 'MF', 'MFDES', 'MT', "MTDES"), all=TRUE)
data.table::setnames(comp, old=c("LIBVERORIG.x","LIBVERORIG.y"), new=c("LIB1","LIB2"))
data.table::setnames(comp, old=c("MFDES","MTDES"), new=c("MF TYPE","MT TYPE"))
comp<-subset(comp, select = c('MF TYPE', 'MT TYPE', 'MF', 'MT', 'LIB1', 'LIB2'))

#counting : 
totalupdated<-dim(comp%>%subset(LIB1!=LIB2 | is.na(LIB1) | is.na(LIB2)))[1]
totunchanged<-dim(comp%>%subset(LIB1==LIB2))[1]
newinlib1<-dim(comp%>%subset(is.na(LIB2)))[1]
erasedfromlib2<-dim(comp%>%subset(is.na(LIB1)))[1]

comp[is.na(comp)] <- 'NA'

UpdatedColor <-"Gray"
NewColor <-"Gray"
ErasedColor <-"Gray"
if(totalupdated > 0) UpdatedColor <- "#b3ffb3"
if(newinlib1 > 0) NewColor <- "#b3ffb3"
if(erasedfromlib2> 0) ErasedColor <- "#ffb3b3"

LIBLINK <-"https://www.oecd-nea.org/dbdata"




```

MF/MT Map
================

```{r child='barheader_lib.Rmd'}
```

### MF-MT Origin {data-height=500}

```{r plotmap}
##plot_map : 
     
    #pdf<-df%>%subset(X==mX & A==mA & M==mM & LIBVER==mLIBVER)
    #tot<-dim(pdf)[1]
 
    title<-paste(mSYMAM," from ", mLIBVER)
    
    axisfont <- list(
      family = "Helvetica",
      size = 14,
      color = "blue"
    )
    
    yaxis=list(titlefont= axisfont)
    xaxis=list( 
      titlefont= axisfont,
      title = "MT",
      zeroline = FALSE,
      showline = FALSE,
      showticklabels = TRUE,
      showgrid = TRUE,
      tickangle=80
    )
    
    #changing column names for better readability in tooltip : 
    setnames(pdf, old=c("MFDES","MTDES", "LIBVERORIG"), new=c("Type","Reaction", "Matches"))
    
    g1<-ggplot(pdf, aes(x=MT, y=MF, Type=Type, Reaction=Reaction)) + 
      geom_tile(aes(fill=Matches)) +
      #geom_tile() +
      scale_y_discrete(drop=FALSE) + 
      scale_fill_manual(values=my_colors)+
      theme_light() + 
      theme(legend.title=element_blank(), 
            plot.background=element_rect(fill="white"), #can be 'darkseagreen' too...
            plot.margin = unit(c(0.7, 0, 2, 1), "cm")) #top, right, bottom, left
    p<-ggplotly(g1, width = 1200, 
                height = 500
                )
    #print(g1)
    
    p%>%config(displayModeBar = 'pan',showLink=FALSE,senddata=FALSE,editable=FALSE,
                 displaylogo=FALSE, collaborate=FALSE, cloud=FALSE,
                 modeBarButtonsToRemove=c('select2d', 'lasso2d','hoverClosestCartesian',
                                          'hoverCompareCartesian'))%>%
      layout(#title=title,
             autosize = F,
             yaxis=yaxis ,
             xaxis=xaxis ,
             showlegend = TRUE
             )
   p
   #plotly_IMAGE(p, format = "png", out_file = "plotmap.png")
```
   
Updated
===========

```{r child='barheader_table.Rmd'}
```

### **Updated** 

Origin of **updated** sections in `r mLIBVER` file,  with respect to reference : `r params$LIBVER2`  

```{r table_updated} 
  d<-comp%>%subset(LIB1!=LIB2 | is.na(LIB1) | is.na(LIB2)) # diff occurrences 
  data.table::setnames(d, old=c("LIB1","LIB2"), new=c(mLIBVER,params$LIBVER2))
  datatable(d, filter='top', options = list(
    pageLength=10,
    rownames=FALSE,
    autowidth=FALSE,
    #scrollY="1000vh",
    columnDefs=list(list(className='dt-center', targets=0:6))
    ))
  

```


New
===========

```{r child='barheader_table.Rmd'}
```

### New 

Origin of **new** sections in `r mLIBVER` file,  with respect to reference : `r params$LIBVER2`  

```{r table_new} 
  n<-comp%>%subset(LIB2=="NA") # new in LIB1 
  data.table::setnames(n, old=c("LIB1","LIB2"), new=c(mLIBVER,params$LIBVER2))
  datatable(n, filter='top', options = list(
    pageLength=10,
    rownames=FALSE,
    autowidth=FALSE,
    #scrollY="1000vh",
    columnDefs=list(list(className='dt-center', targets=0:6))
    ))
  

```






Unchanged
===========

```{r child='barheader_table.Rmd'}
```

### **Unchanged**  

Origin of **unchanged** sections in `r mLIBVER` file, with respect to reference : `r params$LIBVER2` 

```{r table_same} 
  s<-comp%>%subset(LIB1==LIB2) # same occurrences 
  s<-subset(s, select = c('MF TYPE', 'MT TYPE', 'MF', 'MT', 'LIB1'))
  data.table::setnames(s, old=c("LIB1"), new=c("Origin"))
  datatable(s, filter='top', options = list(
    pageLength=10,
    rownames=FALSE,
    autowidth=FALSE,
    #scrollY="100vh",
    columnDefs=list(list(className='dt-center', targets=0:5))
    ))
  

```


Erased
===========

```{r child='barheader_table.Rmd'}
```

### **Erased** 

Origin of **erased** sections in `r mLIBVER` file that were present in reference : `r params$LIBVER2` 

```{r table_erased} 
  e<-comp%>%subset(LIB1=="NA") #  
  data.table::setnames(e, old=c("LIB1","LIB2"), new=c(mLIBVER,params$LIBVER2))
  datatable(e, filter='top', options = list(
    pageLength=10,
    rownames=FALSE,
    autowidth=FALSE,
    #scrollY="1000vh",
    columnDefs=list(list(className='dt-center', targets=0:6))
    ))
  

```

